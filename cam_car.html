<html>

<head>
  <title>MoonCar</title>
  <style>
    #sketchpad {
    border: 2px solid #888;
    border-radius: 200px;
    position: relative;
  }
  </style>
  <script src="https://webbit.webduino.io/blockly/components/jquery/dist/jquery.min.js"></script>
  <script src="https://webbit.webduino.io/blockly/dist/lib/webduino-all.min.js"></script>
  <script src="https://webbit.webduino.io/blockly/dist/edu.min.js"></script>
  <script src="https://webbit.webduino.io/blockly/dist/edu-mpu9250.min.js"></script>
  <script src="https://webbit.webduino.io/blockly/dist/edu-blockly.min.js"></script>
  <script src="https://webbit.webduino.io/blockly/dist/MessageTransport.min.js"></script>
  <script src="https://webbit.webduino.io/blockly/dist/webduino-blockly.min.js"></script>
  <script src="https://webbit.webduino.io/blockly/dist/lib/firebase.min.js"></script>
  <script src="https://webbit.webduino.io/blockly/dist/lib/runtime.min.js"></script>
  <script src="https://webbit.webduino.io/blockly/custom-blocks/car-package/WS2812.js"></script>
  <script src="https://webbit.webduino.io/blockly/custom-blocks/car-package/CarTracker.js"></script>
  <script src="https://webbit.webduino.io/blockly/custom-blocks/car-package/BitIR-blockly.js"></script>
  <script src="https://webbit.webduino.io/blockly/custom-blocks/car-package/BitWS2812-blockly.js"></script>
  <script src="https://webbit.webduino.io/blockly/custom-blocks/car-package/BitCarButton-blockly.js"></script>
  <script src="https://webbit.webduino.io/blockly/custom-blocks/car-package/BitCarTracker-blockly.js"></script>
  <script src="https://webbit.webduino.io/blockly/custom-blocks/car-package/BitUltrasonic-blockly.js"></script>
</head>

<body>
	<br><br>
  <div style="text-align:center;">
    <canvas id='c1' width=480 height=640></canvas>
  </div>
  <br><br>
  <div style="text-align:center;">
    <canvas id="sketchpad" height="600" width="800">
    </canvas>
  </div>
  <script src="js/camera.js"></script>
  <script src="js/ctrlPad.js"></script>
  <script type="text/javascript">
  var param = location.hash.substring(1).split('@');
  var deviceID = param[0];
  var camURL = param[1];
  console.log("deviceID:", deviceID);
  console.log("camURL:", camURL);



  var canvas = document.getElementById('sketchpad');
  boardReady({ board: 'Bit', device: deviceID, transport: 'mqtt', multi: true }, (function (board) {
    window.board = board;
    console.log("Ready...", board);
    var lastLeft = 0;
    var lastRight = 0;
    new CtrlPad(canvas, function (left, right) {
      left = parseInt(left * 100);
      left = left > 100 ? 100 : left < -100 ? -100 : left;
      right = parseInt(right * 100);
      right = right > 100 ? 100 : right < -100 ? -100 : right;
      var action = left >= 0 ? 1 : 4;
      console.log(left, right);
      if (left == 0 && right == 0) {
        CarTracker.init(board).action(0);
      } else if (left < 0 && right < 0) {
        if (left != lastLeft) {
          lastLeft = left;
          CarTracker.init(board).setLeftSpeed(200 + left);
        }
        if (right != lastRight) {
          lastRight = right;
          CarTracker.init(board).setRightSpeed(200 + right);
        }
        CarTracker.init(board).action(4);
      } else {
        if (left != lastLeft) {
          lastLeft = left;
          CarTracker.init(board).setLeftSpeed(left);
        }
        if (right != lastRight) {
          lastRight = right;
          CarTracker.init(board).setRightSpeed(right);
        }
        CarTracker.init(board).action(1);
      }
    });
  }));

  //'bita657a@http://192.168.0.84/jpg?0.1'
  var cam = new Camera(camURL);
  cam.setRotate(90);
  cam.onCanvas('c1', function (c) {
    var ctx = c.getContext('2d');
    drawTime(ctx);
  });

  function drawTime(ctx) {
    ctx.font = "12px Verdana";
    ctx.fillStyle = '#ecdc00';
    var x = ctx.canvas.width - 200;
    var y = ctx.canvas.height - 4;
    ctx.fillText(getDate(), x, y);
  }

  function getDate() {
    var d = new Date();
    dy = d.toLocaleDateString();
    dt = d.toLocaleTimeString();
    return dy + ' ' + dt;
  }
  </script>
</body>

</html>